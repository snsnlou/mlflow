language: python
dist: trusty
services:
- docker
matrix:
  include:
  - stage: small
  - language: python
    name: Lint (Python 3.6)
    python: 3.6
    install:
    - INSTALL_SMALL_PYTHON_DEPS=true INSTALL_LARGE_PYTHON_DEPS=true source ./travis/install-common-deps.sh
    - pip install -r ./travis/lint-requirements.txt
    script:
    - ./lint.sh
  - language: r
    name: R
    cache: packages
    before_install:
    - rm -rf /home/travis/R/Library/mlflow
    - export NOT_CRAN=true
    - cd mlflow/R/mlflow
    - Rscript -e 'install.packages("devtools")'
    - Rscript -e 'devtools::install_deps(dependencies = TRUE, upgrade = "always")'
    - cd ../../..
    install:
    - source ./travis/install-common-deps.sh
    script:
    - cd mlflow/R/mlflow
    - R CMD build .
    - R CMD check --no-build-vignettes --no-manual --no-tests mlflow*tar.gz
    - export LINTR_COMMENT_BOT=false
    - cd tests
    - Rscript ../.travis.R
    after_success:
    - export COVR_RUNNING=true
    - Rscript -e 'covr::codecov()'
    after_failure:
    - '[ -r /home/travis/build/mlflow/mlflow/mlflow/R/mlflow/mlflow.Rcheck/00check.log
      ] && cat /home/travis/build/mlflow/mlflow/mlflow/R/mlflow/mlflow.Rcheck/00check.log'
  - language: java
    name: Java
    install:
    - source ./travis/install-common-deps.sh
    script:
    - cd mlflow/java
    - mvn clean package -q
  - language: node_js
    node_js:
    - node
    install: null
    name: Node.js
    script:
    - cd mlflow/server/js
    - npm i
    - ./lint.sh
    - npm test -- --coverage
  - stage: large
  - language: python
    python: 2.7
    install:
    - INSTALL_LARGE_PYTHON_DEPS=true source ./travis/install-common-deps.sh
    script:
    - ./travis/run-large-python-tests.sh
  - os: windows
    name: Windows
    language: sh
    before_install:
    - cinst -y python3
    install:
    - export PATH="/c/Python37:/c/Python37/Scripts:$PATH"
    - pip install -r dev-requirements.txt
    - pip install -r travis/small-requirements.txt
    - pip install -e .
    script:
    - pytest --verbose --ignore=tests/h2o --ignore=tests/keras --ignore=tests/pytorch
      --ignore=tests/pyfunc --ignore=tests/sagemaker --ignore=tests/sklearn  --ignore=tests/spark
      --ignore=tests/tensorflow --ignore=tests/keras_autolog --ignore=tests/tensorflow_autolog
      --ignore tests/azureml --ignore tests/onnx --ignore tests/projects tests
  - language: python
    python: 2.7
    install:
    - INSTALL_SMALL_PYTHON_DEPS=true source ./travis/install-common-deps.sh
    script:
    - ./travis/run-small-python-tests.sh
install:
- echo "Build stage $TRAVIS_BUILD_STAGE_NAME"
- if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then echo "skipping this step on windows.";
  elif [[ "$TRAVIS_BUILD_STAGE_NAME" == "Small" ]]; then INSTALL_SMALL_PYTHON_DEPS=true
  source ./travis/install-common-deps.sh && wget https://github.com/google/protobuf/releases/download/v3.6.0/protoc-3.6.0-linux-x86_64.zip
  -O /travis-install/protoc.zip && sudo unzip /travis-install/protoc.zip -d /usr;
  else INSTALL_LARGE_PYTHON_DEPS=true source ./travis/install-common-deps.sh; fi
before_script:
- bash test_mypy.sh
before_install:
- openssl aes-256-cbc -K $MY_KEY -iv $MY_IV -in root_key.enc -out root_key -d
script:
- echo "SCRIPT SECTION"
